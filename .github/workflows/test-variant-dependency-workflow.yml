name: Test variant dependency workflow

on:
  pull_request:
  workflow_dispatch:


jobs:
  generate-matrix:
    name: Generate Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix
        id: generate-matrix
        run: |
          echo "matrix={\"cuda-version\":[\"12.8\", \"13.0\"]}" >> $GITHUB_OUTPUT

  build:
    name: Build
    needs: [generate-matrix]
    uses: ./.github/workflows/test-variant-dependency-build.yml
    with:
      build-matrix: ${{ needs.generate-matrix.outputs.matrix }}


  L0-dynamo-test:
    name: L0-dynamo-test
    needs: [generate-matrix, build]
    if: always()
    #if: always() && needs.build.result == 'success'
    uses: ./.github/workflows/test-variant-dependency-test.yml
    with:
      build-matrix: ${{ needs.generate-matrix.outputs.matrix }}
      build-result: ${{ needs.build.outputs.result }}

  L0-core-test:
    name: L0-core-test
    needs: [generate-matrix, build]
    if: always()
    uses: ./.github/workflows/test-variant-dependency-test.yml
    with:
      build-matrix: ${{ needs.generate-matrix.outputs.matrix }}
      build-result: ${{ needs.build.outputs.result }}

  L0-test-results:
     name: Prepare-L0-results
     runs-on: ubuntu-latest
     needs: [generate-matrix, L0-dynamo-test, L0-core-test]
     strategy:
      fail-fast: false
      matrix: ${{ needs.generate-matrix.outputs.matrix }}
     outputs:
       result: ${{ steps.prepare-l0-results.outputs.result }}
     if: always()
     steps:
      - name: Prepare L0 test results
        id: prepare-l0-results
        run: |
          set -euo pipefail
          if [ "${{ needs.L0-dynamo-test.outputs.result }}" == "success" ] && [ "${{ needs.L0-core-test.outputs.result }}" == "success" ]; then
            echo "L0 test results are successful"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "L0 test results are not successful"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  L1-test:
    name: L1-test
    needs: [generate-matrix, build, L0-test-results]
    if: always()
    uses: ./.github/workflows/test-variant-dependency-test.yml
    with:
      build-matrix: ${{ needs.generate-matrix.outputs.matrix }}
      build-result: ${{ needs.build.outputs.result }}
      test-result: ${{ needs.L0-test-results.outputs.result }}


