name: Sync uv.lock

on:
  schedule:
    # Every Monday at 03:00 UTC; adjust as needed
    - cron: "0 3 * * 1"
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'setup.py'
  workflow_dispatch:  # allow manual runs

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-uv-lock:
    runs-on: linux.g5.4xlarge.nvidia.gpu
    container:
      image: pytorch/manylinux2_28-builder:cuda13.0
      options: --gpus all
      env:
        CUDA_VERSION: 13.0
        CUDA_HOME: /usr/local/cuda

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.UV_LOCK_PR_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install bazel
        run: |
         set -euo pipefail
         set -x
          curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.26.0/bazelisk-linux-amd64 \
          -o bazelisk-linux-amd64 \
          && mv bazelisk-linux-amd64 /usr/local/bin/bazel \
          && chmod +x /usr/local/bin/bazel
          bazel --version

      - name: UV lock and check for changes
        id: check-changes
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          set -x
          git config --global safe.directory "$GITHUB_WORKSPACE"

          if ! uv lock; then
            echo "Error: Failed to update uv.lock"
            exit 1
          fi
          echo "successfully ran uv lock"
          if git diff --quiet uv.lock; then
            echo "No changes to uv.lock"
            exit 0
          fi
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "there is changes to the uv.lock file"

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.UV_LOCK_PR_TOKEN }}
          commit-message: "chore: update uv.lock"
          base: ${{ github.event_name == 'pull_request' && github.base_ref || github.ref_name }}
          title: "uv.lock file updates"
          body: |
            ## Summary
            Automated update of UV lockfiles to ensure all dependencies are current.
            
            ### Changes include:
            - Updated dependency versions in `uv.lock`

            ### Next Steps:
            - Review the updated dependencies
            - Run CI to ensure no breaking changes
            - Merge if all tests pass
            
            ---
            
            *Auto-generated by [uv-update](.github/workflows/uv-update.yml) workflow*
          branch: "update/uv-lockfiles-${{ github.run_id }}"
          delete-branch: true
          assignees: ""
          reviewers: ""
          draft: false

concurrency:
  group: ${{ github.workflow }}-uv-update-${{ github.event.pull_request.number || github.ref_name }}-${{ github.event_name == 'workflow_dispatch' }}
  cancel-in-progress: true